<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/_page-layout}">
<head>
    <title>View clients</title>

    <style>
        .validation-error {
            color: red;
            font-size: 12px;
        }

        .custom-form-label {
            font-weight: bold;
            color: #404040;
        }
    </style>
</head>

<div layout:fragment="main">
    <!-- Modal for client registration/edit -->
    <form id="main-form" th:object="${client}" onsubmit="return validateGender();" method="post">
        <th:block th:replace="~{fragments/_csrf :: csrf}"></th:block>
        <div class="modal fade" id="main-modal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-light">
                        <h4 class="modal-title" id="main-modal-title"></h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-hidden="true"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label id="first-name-label" for="first-name" class="form-label custom-form-label">First
                                Name</label>
                            <input type="text" class="form-control" id="first-name"
                                   placeholder="Enter first name" th:field="*{firstName}" minlength="2"
                                   maxlength="50" pattern="^[a-zA-Z]{2,50}$"
                                   title="First name must be between 2 and 50 characters long." required>
                            <span class="validation-error" th:if="${#fields.hasErrors('firstName')}"
                                  th:errors="*{firstName}"></span>
                        </div>
                        <div class="mb-3">
                            <label id="last-name-label" for="last-name" class="form-label custom-form-label">
                                Last Name</label>
                            <input type="text" class="form-control" id="last-name"
                                   placeholder="Enter last name" th:field="*{lastName}" minlength="2"
                                   maxlength="50" pattern="^[a-zA-Z]{2,50}$"
                                   title="Last name must be between 2 and 50 characters long." required>
                            <span class="validation-error" th:if="${#fields.hasErrors('lastName')}"
                                  th:errors="*{lastName}"></span>
                        </div>
                        <div class="mb-3">
                            <label id="date-of-birth-label" for="date-of-birth" class="form-label custom-form-label">
                                Date Of Birth</label>
                            <input type="date" class="form-control" id="date-of-birth" th:field="*{dateOfBirth}"
                                   required>
                            <span class="validation-error" th:if="${#fields.hasErrors('dateOfBirth')}"
                                  th:errors="*{dateOfBirth}"></span>
                        </div>
                        <div>
                            <label class="form-label custom-form-label">Gender</label>
                            <div class="form-check mb-1">
                                <label>Male
                                    <input type="radio" id="male-radio-button" name="gender"
                                           class="form-check-input" value="M" th:field="*{gender}">
                                </label>
                            </div>
                            <div class="form-check form-check-pink">
                                <label>Female
                                    <input type="radio" id="female-radio-button" name="gender" value="F"
                                           th:field="*{gender}" class="form-check-input">
                                </label><br>
                            </div>
                            <div class="mb-3" th:switch="${#fields.hasErrors('gender')}">
                                <!--suppress XmlDuplicatedId -->
                                <span id="gender-error" class="validation-error" th:case="${true}"
                                      th:errors="*{gender}"></span>
                                <!--suppress XmlDuplicatedId -->
                                <span id="gender-error" class="validation-error" th:case="*"></span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label id="email-label" for="email" class="form-label custom-form-label">
                                Email Address</label>
                            <input type="email" class="form-control" id="email" placeholder="Enter email"
                                   th:field="*{email}" minlength="3" maxlength="50" required>
                            <span class="validation-error" th:if="${#fields.hasErrors('email')}"
                                  th:errors="*{email}"></span>
                        </div>
                        <div class="mb-3">
                            <label id="phone-label" for="phone" class="form-label custom-form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone" placeholder="Enter phone"
                                   th:field="*{phone}" minlength="8" maxlength="20" pattern="^[0-9]{8,20}$"
                                   title="Phone number must be between 8 and 20 digits long." required>
                            <span class="validation-error" th:if="${#fields.hasErrors('phone')}"
                                  th:errors="*{phone}"></span>
                        </div>
                    </div>
                    <div class="modal-footer d-flex">
                        <button type="button" class="btn btn-secondary me-auto"
                                onclick="document.getElementById('main-form').reset();">Reset
                        </button>
                        <button type="submit" class="btn btn-success"></button>
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
    </form>

    <!-- Modal for client deletion -->
    <div id="delete-client-modal" class="modal fade" tabindex="-1" role="dialog"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="text-center">
                        <i class="dripicons-warning h1 text-warning"></i>
                        <h4 id="client-fullname-delete-modal" class="mt-2"></h4>
                        <p class="mt-3">You are about to delete this client. Do you want to continue?</p>
                        <button id="confirm-client-deletion-button" type="button" class="btn btn-warning my-2">
                            Continue
                        </button>
                        <button type="button" class="btn btn-danger my-2" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <!-- Modal for client tags -->
    <form id="client-tags-form">
        <div id="client-tags-modal" class="modal fade" tabindex="-1" role="dialog"
             aria-labelledby="client-tags-modal-label"
             aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="client-tags-modal-title">Client tags</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-4" th:each="tagCategory: ${tagCategories}">
                            <div class="row">
                                <h5 class="form-label custom-form-label mb-2" th:text="${tagCategory.name}"></h5>
                                <div th:each="tag: ${tagCategory.tags}" class="col-lg-4">
                                    <input th:id="${'tag-'+tag.id}" th:value="${tag.id}" type="checkbox"
                                           class="form-check-input rounded-circle">
                                    <label th:for="${'tag-'+tag.id}" class="form-check-label"
                                           th:text="${tag.name}"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary me-auto"
                                onclick="document.getElementById('client-tags-form').reset();">Reset
                        </button>
                        <button id="save-tags-button" type="button" class="btn btn-success">Save</button>
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
    </form>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row justify-content-between">
                        <div class="col-md-4">
                            <div class="mt-3 mt-md-0">
                                <button class="btn btn-lg font-16 btn-success" data-bs-toggle="modal"
                                        id="registration-button" data-bs-target="#main-modal"
                                        onclick="fillMainModal('/clients/registerClient', 'Register client', 'Register')">
                                    <i class="fa fa-plus me-1"></i> Register client
                                </button>
                            </div>
                        </div><!-- end col-->
                        <div class="col-md-8">
                            <form class="d-flex flex-wrap align-items-center justify-content-sm-end">
                                <label for="status-select" class="me-2">Sort By</label>
                                <div class="me-sm-2">
                                    <select class="form-select my-1 my-md-0" id="status-select">
                                        <option value="1" selected>First Name</option>
                                        <option value="2">Last Name</option>
                                        <option value="3">Gender</option>
                                    </select>
                                </div>
                                <label for="inputPassword2" class="visually-hidden">Search</label>
                                <div>
                                    <input type="search" class="form-control my-1 my-md-0" id="inputPassword2"
                                           placeholder="Search...">
                                </div>
                            </form>
                        </div>
                    </div> <!-- end row -->
                </div>
            </div> <!-- end card -->
        </div><!-- end col-->
    </div>
    <!-- end row -->

    <div class="row" th:with="maleImg=@{/images/users/male.png}, femaleImg=@{/images/users/female.png}">
        <div class="col-xl-4" th:each="c :${clients}">
            <div class="card">
                <div class="text-center card-body">
                    <div class="dropdown float-end">
                        <a class="dropdown-toggle arrow-none card-drop" data-bs-toggle="dropdown"
                           aria-expanded="false">
                            <i class="mdi mdi-dots-vertical"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end">
                            <a th:id="${'update-anchor-button-'+c.id}" class="dropdown-item" data-bs-toggle="modal"
                               data-bs-target="#main-modal"
                               th:onclick="fillMainModal(
                               [['/clients/updateClient/'+${c.id}]], 'Edit profile', 'Save',
                               [[${c.firstName}]], [[${c.lastName}]], [[${c.dateOfBirth}]],
                               [[${c.gender}]], [[${c.email}]], [[${c.phone}]], true
                               )">
                                Edit profile</a>
                            <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#client-tags-modal"
                               th:onclick="fillClientTagsModal([[${c.id}]])">
                                Client tags</a>
                            <a class="dropdown-item" data-bs-toggle="modal"
                               data-bs-target="#delete-client-modal"
                               th:onclick="fillDeleteModal([[${c.getFullName()}]],[[${c.id}]])">Delete
                                client</a>
                        </div>
                    </div>
                    <div>
                        <img th:src="${c.gender.toString() == 'F'} ? ${femaleImg} : ${maleImg}"
                             class="rounded-circle avatar-xl img-thumbnail mb-2" alt="profile-image">

                        <div class="text-start">
                            <p class="text-muted font-13"><strong>First Name :</strong> <span
                                    class="ms-1" th:text="${c.firstName}"></span>
                            </p>

                            <p class="text-muted font-13"><strong>Last Name :</strong> <span
                                    class="ms-1" th:text="${c.lastName}"></span>
                            </p>

                            <p class="text-muted font-13"><strong>Date Of Birth :</strong> <span
                                    class="ms-1" th:text="${c.getFormattedDateOfBirth()}"></span>
                            </p>

                            <p class="text-muted font-13"><strong>Phone :</strong> <span
                                    class="ms-1" th:text="${c.phone}"></span>
                            </p>

                            <p class="text-muted font-13"><strong>Email :</strong> <span
                                    class="ms-1" th:text="${c.email}"></span>
                            </p>
                        </div>

                        <button type="button" class="btn btn-primary rounded-pill waves-effect waves-light">Send
                            Message
                        </button>
                    </div>
                </div>
            </div>
        </div> <!-- end col -->
    </div>
    <!-- end row -->

    <!-- Custom scripts -->
    <th:block th:if="${registerValidationsFailed}">
        <!-- Server-side register client validations returned errors. Open the main modal. -->
        <script th:inline="javascript">
            window.onload = () => {
                document.getElementById('registration-button').click();
                document.getElementById('date-of-birth').value = [[${dateOfBirth}]];
            }
        </script>
    </th:block>

    <th:block th:if="${updateValidationsFailed}">
        <!-- Server-side update client validations returned errors. -->
        <script th:inline="javascript">
            // Open the main modal and fill it with the edited client's data.
            window.onload = () => {
                document.getElementById('update-anchor-button-' + [[${editedClient.id}]]).click();
                document.getElementById("first-name").value = [[${editedClient.firstName}]];
                document.getElementById("last-name").value = [[${editedClient.lastName}]];
                document.getElementById("date-of-birth").value = [[${editedClient.dateOfBirth}]];
                document.getElementById("email").value = [[${editedClient.email}]];
                document.getElementById("phone").value = [[${editedClient.phone}]];
                document.getElementById("male-radio-button").checked = [[${editedClient.gender}]] === 'M';
                document.getElementById("female-radio-button").checked = [[${editedClient.gender}]] === 'F';
            }
        </script>
    </th:block>

    <script th:inline="javascript">
        // Change page title.
        const title = document.getElementsByClassName("page-title-main");
        title[0].textContent = "Clients";

        // Reset main form and validation errors on main modal close.
        document.getElementById("main-modal").onhidden = () => {
            document.getElementById("main-form").reset();
            document.getElementsByClassName("validation-error").forEach(element => {
                element.textContent = "";
            });
        }

        // Reset client tags form on client tags modal close.
        document.getElementById("client-tags-modal").onhidden = () => document.getElementById("client-tags-form").reset();

        function validateGender() {
            // Validate gender radio buttons, if none is selected, display an error message and prevent form submission.
            const maleRadioButton = document.getElementById("male-radio-button");
            const femaleRadioButton = document.getElementById("female-radio-button");
            if (maleRadioButton.checked || femaleRadioButton.checked) {
                document.getElementById("gender-error").textContent = "";
                return true;
            }
            document.getElementById("gender-error").textContent = "Gender is required.";
            return false;
        }

        function fillMainModal(
            action, title, actionButtonText,
            firstName = '', lastName = '', dateOfBirth = '',
            gender = '', email = '', phone = '',
            edit = false
        ) {
            //  Fill the main modal with the provided form action, title, and action button text.
            document.getElementById("main-form").setAttribute("action", action);
            document.querySelector("#main-modal-title").textContent = title;
            document.querySelector("#main-modal .btn-success").textContent = actionButtonText;

            // If the modal is for registering a new client, return.
            if (!edit) return;

            // If the modal is for editing a client, fill the form fields with the client's data.
            document.getElementById("first-name").value = firstName;
            document.getElementById("last-name").value = lastName;
            document.getElementById("date-of-birth").value = dateOfBirth;
            document.getElementById("email").value = email;
            document.getElementById("phone").value = phone;
            document.getElementById("male-radio-button").checked = gender === 'M';
            document.getElementById("female-radio-button").checked = gender === 'F';
        }

        function fillDeleteModal(clientName, id) {
            // Set the client's full name who is about to be deleted.
            document.getElementById("client-fullname-delete-modal").textContent = clientName;

            // Set onclick event for the delete button.
            document.getElementById("confirm-client-deletion-button").onclick = () => deleteClient(id);
        }

        async function deleteClient(id) {
            // Delete the client with the provided id.
            const response = await fetch('/api/clients/' + id, {
                method: 'DELETE',
                headers: {
                    [[${_csrf.headerName}]]: [[${_csrf.token}]]
                }
            });

            if (response.ok) {
                location.reload(); // Reload the page to reflect the changes.
            } else {
                // Todo: Maybe I can show a failure modal.
                alert("Client deletion failed. Please try again later. If the problem persists, contact support.");
            }
        }

        async function fillClientTagsModal(id) {
            // Fill the client tags modal with the client's tags.
            const response = await fetch('/api/clients/' + id + '/tags');

            if (response.ok) {
                const tags = await response.json();
                tags.forEach(tag => {
                    document.getElementById("tag-" + tag.id).checked = true;
                });

                // Set onclick event for the save tags button.
                document.getElementById("save-tags-button").onclick = () => saveTags(id);
            } else {
                // Todo: Maybe I can show a failure modal.
                alert("An error occurred while fetching the client tags. Please try again later." +
                    "If the problem persists, contact support.");
                location.reload();
            }
        }

        async function saveTags(id) {
            // Save the selected tags for the client.
            const tags = [];
            document.querySelectorAll("#client-tags-modal input[type='checkbox']:checked").forEach(tag => {
                tags.push(tag.value);
            });

            const response = await fetch('/api/clients/' + id + '/tags', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    [[${_csrf.headerName}]]: [[${_csrf.token}]]
                },
                body: JSON.stringify(tags)
            });

            if (response.ok) {
                // Todo: Maybe I can show a success modal.
                alert("Client tags saved successfully.");
            } else {
                // Todo: Maybe I can show a failure modal.
                alert("An error occurred while saving the client tags. Please try again later." +
                    "If the problem persists, contact support.");
            }
        }
    </script>
</div>
</html>